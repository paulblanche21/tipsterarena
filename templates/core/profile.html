{% extends 'core/base.html' %}
{% load static %}
{% block title %}{{ user.username }} - Tipster Arena{% endblock %}

{% block content %}
    <div class="profile-content">
        <!-- Username and Post Count (Header) with Back Arrow -->
        <div class="profile-header-top">
            <a href="{% url 'home' %}" class="profile-back-arrow"><i class="fas fa-arrow-left"></i></a>
            <div class="profile-username-container">
                <h1 class="profile-username">{{ user.username }}</h1>
                <span class="user-handle">{{ user_profile.handle }}</span> <!-- Changed to user-handle for consistency -->
                <p class="profile-post-count">{{ user_tips.count }} Posts</p>
            </div>
        </div>

        <!-- Banner and Avatar -->
        <div class="profile-header">
            {% if user_profile.banner %}
                <img src="{{ user_profile.banner.url }}" alt="Banner Image" class="profile-banner" onerror="setDefaultBanner(this);">
            {% else %}
                <img src="{% static 'images/default-banner.png' %}" alt="Default Banner Image" class="profile-banner">
            {% endif %}
            {% if user_profile.avatar %}
                <img src="{{ user_profile.avatar.url }}" alt="{{ user.username }} Avatar" class="profile-avatar" onerror="setDefaultAvatar(this);">
            {% else %}
                <img src="{% static 'images/default-avatar.png' %}" alt="{{ user.username }} Avatar" class="profile-avatar">
            {% endif %}
            <div class="profile-actions">
                {% if is_owner %}
                    <button class="profile-edit-btn" id="editProfileBtn">Edit Profile</button>
                {% else %}
                    <button class="follow-btn" data-username="{{ user.username }}">
                        {% if is_following %}Following{% else %}Follow{% endif %}
                    </button>
                {% endif %}
            </div>
        </div>

        <!-- Username, Handle, and Bio Below Avatar -->
        <div class="profile-user-info">
            <div class="profile-user-details">
                <h2 class="profile-username">{{ user.username }}</h2>
                <span class="user-handle">{{ user_profile.handle }}</span> <!-- Fixed from tip.user.userprofile.handle -->
                <p class="profile-description">{{ user_profile.description|default:"No description provided." }}</p>
            </div>  
        </div>

        <!-- Remaining sections unchanged -->
        <div class="profile-details">
            <span class="profile-detail-item"><i class="fas fa-map-marker-alt"></i> {{ user_profile.location|default:"Not specified" }}</span>
            <span class="profile-detail-item"><i class="fas fa-birthday-cake"></i> {{ user_profile.date_of_birth|date:"F d, Y"|default:"Not specified" }}</span>
            <span class="profile-detail-item"><i class="fas fa-calendar-check"></i> {{ user.date_joined|date:"F Y" }}</span>
        </div>

        <div class="profile-follow">
            <span><strong>{{ following_count }}</strong> Following</span>
            <span><strong>{{ followers_count }}</strong> Followers</span>
        </div>

        <div class="profile-nav">
            <a href="#" class="profile-nav-item active">Posts</a>
            <a href="#" class="profile-nav-item">Replies</a>
            <a href="#" class="profile-nav-item">Media</a>
            <a href="#" class="profile-nav-item">Articles</a>
            <a href="#" class="profile-nav-item">Likes</a>
        </div>

        <div class="tip-feed">
            {% for tip in user_tips %}
                <div class="tip">
                    {% if tip.user.userprofile.avatar %}
                        <img src="{{ tip.user.userprofile.avatar.url }}" alt="{{ tip.user.username }} Avatar" class="tip-avatar">
                    {% else %}
                        <img src="{% static 'images/default-avatar.png' %}" alt="{{ tip.user.username }} Avatar" class="tip-avatar" onerror="this.style.display='none'">
                    {% endif %}
                    <div class="tip-content">
                        <strong>{{ tip.user.username }}</strong>
                        <span class="user-handle">{{ tip.user.userprofile.handle }}</span>
                        {% if tip.sport == 'football' %}‚öΩ{% endif %}
                        {% if tip.sport == 'golf' %}‚õ≥{% endif %}
                        {% if tip.sport == 'tennis' %}üéæ{% endif %}
                        {% if tip.sport == 'horse_racing' %}üèá{% endif %}
                        <p>{{ tip.text }}</p>
                        <small>{{ tip.created_at|date:"F j, Y, g:i a" }}</small>
                        <div class="tip-actions">
                            <div class="tip-action-group">
                                <a href="#" class="tip-action tip-action-like"><i class="fas fa-heart"></i></a>
                                <span class="tip-action-count">79</span>
                            </div>
                            <div class="tip-action-group">
                                <a href="#" class="tip-action tip-action-retweet"><i class="fas fa-retweet"></i></a>
                                <span class="tip-action-count">7</span>
                            </div>
                            <div class="tip-action-group">
                                <a href="#" class="tip-action tip-action-comment"><i class="fas fa-comment-dots"></i></a>
                                <span class="tip-action-count">11</span>
                            </div>
                            <div class="tip-action-spacer"></div> <!-- Spacer to position engagement icon -->
                            <div class="tip-action-group">
                                <a href="#" class="tip-action tip-action-engagement"><i class="fas fa-users"></i></a>
                                <span class="tip-action-count">6.5K</span>
                            </div>
                            <div class="tip-action-spacer-large"></div> <!-- Larger spacer to push bookmark and share right -->
                            <div class="tip-action-group">
                                <a href="#" class="tip-action tip-action-bookmark"><i class="fas fa-bookmark"></i></a>
                            </div>
                            <div class="tip-action-group">
                                <a href="#" class="tip-action tip-action-share"><i class="fas fa-arrow-up"></i></a>
                            </div>
                        </div>
                    </div>
                </div>
            {% empty %}
                <p>No posts yet. Start posting tips!</p>
            {% endfor %}
        </div>
    </div>

    <div id="editProfileModal" class="profile-edit-modal">
        <div class="profile-edit-modal-content">
            <span class="profile-edit-modal-close">√ó</span>
            <h2>Edit Profile</h2>
            <div class="edit-profile-header">
                <div class="profile-edit-banner">
                    {% if user_profile.banner %}
                        <img src="{{ user_profile.banner.url }}" alt="Banner Image" class="profile-edit-banner-img" onerror="setDefaultBanner(this);">
                    {% else %}
                        <img src="{% static 'images/default-banner.png' %}" alt="Default Banner Image" class="profile-edit-banner-img">
                    {% endif %}
                    <div class="profile-edit-actions">
                        <button class="profile-edit-action-btn" data-action="add-banner"><i class="fas fa-camera"></i></button>
                        <button class="profile-edit-action-btn" data-action="delete-banner"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="profile-edit-avatar">
                        {% if user_profile.avatar %}
                            <img src="{{ user_profile.avatar.url }}" alt="Avatar" class="profile-edit-avatar-img" onerror="setDefaultAvatar(this);">
                        {% else %}
                            <img src="{% static 'images/default-avatar.png' %}" alt="Avatar" class="profile-edit-avatar-img">
                        {% endif %}
                        <div class="profile-edit-actions">
                            <button class="profile-edit-action-btn" data-action="add-avatar"><i class="fas fa-camera"></i></button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="edit-profile-form">
                <form method="post" enctype="multipart/form-data" id="editProfileForm">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="id_description">Bio</label>
                        {{ form.description }}
                        <small class="char-count" style="color: #666666; font-size: 12px;">{{ form.description.value|length }} / 160 characters</small>
                    </div>
                    <div class="form-group">
                        <label for="id_location">Location (Optional)</label>
                        {{ form.location }}
                    </div>
                    <div class="form-group">
                        <label for="id_date_of_birth">Birth Date (Optional)</label>
                        {{ form.date_of_birth }}
                    </div>
                    <div class="form-group">
                        <label for="id_banner">Banner</label>
                        {{ form.banner }}
                    </div>
                    <div class="form-group">
                        <label for="id_avatar">Avatar</label>
                        {{ form.avatar }}
                    </div>
                    <button type="submit" class="post-submit">Save Changes</button>
                </form>
            </div>
        </div>
    </div>
    {% endblock %}
    {% block upcoming_events %}
    <div class="sidebar-card upcoming-events-card" data-card="upcoming-events" style="background-color: white;">
        <h3>Upcoming Fixtures</h3>
        <div class="carousel-container">
            <div class="carousel-slide active" data-league="premier-league">
                <div class="event-list">
                    <!-- Premier League Fixtures (5) -->
                    <p class="event-item"><span class="sport-icon">‚öΩ</span> Premier League: Manchester United vs. Tottenham, Mar 12, 2025</p>
                    <p class="event-item"><span class="sport-icon">‚öΩ</span> Premier League: Liverpool vs. Manchester City, Mar 21, 2025</p>
                    <p class="event-item"><span class="sport-icon">‚öΩ</span> Premier League: Arsenal vs. Chelsea, Mar 25, 2025</p>
                    <p class="event-item"><span class="sport-icon">‚öΩ</span> Premier League: Tottenham vs. Manchester United, Mar 28, 2025</p>
                    <p class="event-item"><span class="sport-icon">‚öΩ</span> Premier League: Manchester City vs. Liverpool, Apr 1, 2025</p>
                </div>
            </div>
            <div class="carousel-slide" data-league="la-liga">
                <div class="event-list">
                    <p class="event-item"><span class="sport-icon">‚öΩ</span> La Liga: Real Madrid vs. Barcelona, Mar 15, 2025</p>
                    <p class="event-item"><span class="sport-icon">‚öΩ</span> La Liga: Atletico Madrid vs. Sevilla, Mar 22, 2025</p>
                    <p class="event-item"><span class="sport-icon">‚öΩ</span> La Liga: Barcelona vs. Real Madrid, Mar 26, 2025</p>
                    <p class="event-item"><span class="sport-icon">‚öΩ</span> La Liga: Sevilla vs. Atletico Madrid, Apr 2, 2025</p>
                    <p class="event-item"><span class="sport-icon">‚öΩ</span> La Liga: Real Madrid vs. Valencia, Apr 5, 2025</p>
                </div>
            </div>
            <div class="carousel-slide" data-league="serie-a">
                <div class="event-list">
                    <p class="event-item"><span class="sport-icon">‚öΩ</span> Serie A: Juventus vs. Inter Milan, Mar 18, 2025</p>
                    <p class="event-item"><span class="sport-icon">‚öΩ</span> Serie A: AC Milan vs. Napoli, Mar 23, 2025</p>
                    <p class="event-item"><span class="sport-icon">‚öΩ</span> Serie A: Inter Milan vs. Juventus, Mar 29, 2025</p>
                    <p class="event-item"><span class="sport-icon">‚öΩ</span> Serie A: Napoli vs. AC Milan, Apr 3, 2025</p>
                    <p class="event-item"><span class="sport-icon">‚öΩ</span> Serie A: Juventus vs. Roma, Apr 6, 2025</p>
                </div>
            </div>
            <div class="carousel-slide" data-league="bundesliga">
                <div class="event-list">
                    <p class="event-item"><span class="sport-icon">‚öΩ</span> Bundesliga: Dortmund vs. Leipzig, Mar 19, 2025</p>
                    <p class="event-item"><span class="sport-icon">‚öΩ</span> Bundesliga: Leipzig vs. Dortmund, Mar 30, 2025</p>
                    <p class="event-item"><span class="sport-icon">‚öΩ</span> Bundesliga: Bayern Munich vs. Frankfurt, Apr 4, 2025</p>
                    <p class="event-item"><span class="sport-icon">‚öΩ</span> Bundesliga: Dortmund vs. Bayern Munich, Apr 7, 2025</p>
                    <p class="event-item"><span class="sport-icon">‚öΩ</span> Bundesliga: Leipzig vs. Wolfsburg, Apr 10, 2025</p>
                </div>
            </div>
            <div class="carousel-slide" data-league="champions-league">
                <div class="event-list">
                    <p class="event-item"><span class="sport-icon">‚öΩ</span> Champions League: Bayern Munich vs. PSG, Mar 16, 2025</p>
                    <p class="event-item"><span class="sport-icon">‚öΩ</span> Champions League: PSG vs. Bayern Munich, Mar 27, 2025</p>
                    <p class="event-item"><span class="sport-icon">‚öΩ</span> Champions League: Manchester City vs. Real Madrid, Apr 8, 2025</p>
                    <p class="event-item"><span class="sport-icon">‚öΩ</span> Champions League: Real Madrid vs. Manchester City, Apr 11, 2025</p>
                    <p class="event-item"><span class="sport-icon">‚öΩ</span> Champions League: Barcelona vs. Juventus, Apr 14, 2025</p>
                </div>
            </div>
        </div>
        <div class="carousel-dots">
            <span class="dot active" data-league="premier-league"></span>
            <span class="dot" data-league="la-liga"></span>
            <span class="dot" data-league="serie-a"></span>
            <span class="dot" data-league="bundesliga"></span>
            <span class="dot" data-league="champions-league"></span>
        </div>
        <a href="#" class="show-more" data-target="upcoming-events">Show more</a>
    </div>
    {% endblock %}

    {% block trending_tips %}
    <div class="sidebar-card trending-tips-card" data-card="trending-tips" style="background-color: white;">
        <h3>Trending Tips</h3>
        <div class="trending-tips-list">
            <div class="trending-tip">
                <img src="{% static 'images/default-avatar.png' %}" alt="User Avatar" class="tip-avatar" onerror="this.style.display='none'">
                <div class="tip-details">
                    <a href="#" class="tip-username"><strong>@TennisGuru</strong></a>
                    <p class="tip-text">Djokovic to win Australian Open - Odds: 3.5</p>
                </div>
                <span class="tip-likes"><i class="fas fa-heart"></i> 250</span>
            </div>
            <div class="trending-tip">
                <img src="{% static 'images/default-avatar.png' %}" alt="User Avatar" class="tip-avatar" onerror="this.style.display='none'">
                <div class="tip-details">
                    <a href="#" class="tip-username"><strong>@AceBettor</strong></a>
                    <p class="tip-text">Swiatek top 4 at French Open - Odds: 2.0</p>
                </div>
                <span class="tip-likes"><i class="fas fa-heart"></i> 180</span>
            </div>
            <div class="trending-tip">
                <img src="{% static 'images/default-avatar.png' %}" alt="User Avatar" class="tip-avatar" onerror="this.style.display='none'">
                <div class="tip-details">
                    <a href="#" class="tip-username"><strong>@GoalMaster</strong></a>
                    <p class="tip-text">Man Utd to beat Tottenham - Odds: 2.8</p>
                </div>
                <span class="tip-likes"><i class="fas fa-heart"></i> 200</span>
            </div>
            <div class="trending-tip">
                <img src="{% static 'images/default-avatar.png' %}" alt="User Avatar" class="tip-avatar" onerror="this.style.display='none'">
                <div class="tip-details">
                    <a href="#" class="tip-username"><strong>@RaceKing</strong></a>
                    <p class="tip-text">Horse X to win Grand National - Odds: 8.0</p>
                </div>
                <span class="tip-likes"><i class="fas fa-heart"></i> 150</span>
            </div>
        </div>
        <a href="#" class="show-more" data-target="trending-tips">Show more</a>
    </div>
    {% endblock %}

{% block extra_styles %}
    <!-- No inline CSS; styles are in styles.css -->
{% endblock %}

{% block extra_scripts %}
    <!-- Removed redundant DEFAULT_BANNER_URL declaration -->
{% endblock %}