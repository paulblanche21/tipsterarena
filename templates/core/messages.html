<!-- templates/core/messages.html -->
{% extends 'core/base.html' %}
{% load static %}
{% block title %}Messages - Tipster Arena{% endblock %}

{% block body_class %}messages-page{% endblock %}

{% block content %}
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
    <!-- Messages Feed (narrower center column, like X’s Messages sidebar) -->
    <div class="messages-feed">
        <h2 class="messages-header">
            <span class="messages-title">Messages</span>
            <span class="messages-icons">
                <span class="messages-settings"><i class="fa-solid fa-gear"></i></span>
                <span class="messages-new" id="newMessageBtn"><i class="fa-solid fa-envelope"></i></span>
            </span>
        </h2>
        {% if message_threads %}
            {% for thread in message_threads %}
                <div class="card" data-thread-id="{{ thread.id }}">
                    {% with other_participant=thread.get_other_participant|default:"Unknown User" %}
                        {% if other_participant.userprofile.avatar %}
                            <img src="{{ other_participant.userprofile.avatar.url }}" alt="User Avatar" class="avatar">
                        {% else %}
                            <img src="{% static 'images/default-avatar.png' %}" alt="Default Avatar" class="avatar" onerror="this.style.display='none'">
                        {% endif %}
                        <div class="card-content">
                            <p>
                                <strong>{{ other_participant.username|default:"Unknown User" }}</strong>
                                <span class="user-handle">@{{ other_participant.userprofile.handle|default:other_participant.username }}</span>
                                <span class="message-date">{{ thread.updated_at|date:"M d" }}</span>
                            </p>
                            <p>{{ thread.last_message|truncatechars:50|default:"No message" }}</p>
                        </div>
                    {% endwith %}
                </div>
            {% empty %}
                <div class="card">
                    <div class="card-content">
                        <p>No messages yet. Start a conversation!</p>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="card">
                <div class="card-content">
                    <p>No messages yet. Start a conversation!</p>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- Modal for New Message -->
    <div id="newMessageModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeModalBtn">×</span>
            <h3>New Message</h3>
            <input type="text" id="recipientUsername" placeholder="Enter username...">
            <div id="userSuggestions"></div>
            <button id="startConversationBtn">Start Conversation</button>
        </div>
    </div>
{% endblock %}

{% block sidebar %}
    <aside class="sidebar-messages" id="messageContent">
        <div class="sidebar-message-content">
            <h3>Select a message</h3>
            <p>Choose from your existing conversations, start a new one, or just keep swimming.</p>
            <button class="new-message-btn" id="newMessageSidebarBtn">New message</button>
        </div>
    </aside>
{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/messages.css' %}">
{% endblock %}

{% block extra_js %}
    <!-- No additional scripts needed, as main.js dynamically imports messages.js -->
{% endblock %}