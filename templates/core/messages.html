<!-- templates/core/messages.html -->
{% extends 'core/base.html' %}
{% load static %}
<!-- messages.html: Template for the Messages page in Tipster Arena. Displays message threads and conversation details. -->

{% block extra_css %}
    <!-- Additional stylesheet for messages-specific styling -->
    <link rel="stylesheet" href="{% static 'css/messages.css' %}">
{% endblock %}

{% block title %}Messages - Tipster Arena{% endblock %}

{% block body_class %}messages-page{% endblock %}

{% block content %}
    <!-- Messages feed (left side) -->
    <div class="messages-feed">
        <div class="messages-header">
            <h2>Messages</h2>
            <div class="messages-icons">
                <button class="messages-settings" onclick="openSettingsModal()" title="Settings">
                    <i class="fas fa-cog"></i>
                </button>
                <button class="messages-new" onclick="openNewMessageModal()" title="New Message">
                    <i class="fas fa-edit"></i>
                </button>
            </div>
        </div>
        <div class="messages-list">
            {% for message in messages %}
            <div class="card" data-thread-id="{{ message.thread.id }}">
                <img src="{{ message.sender.profile.avatar.url|default:'/static/images/default-avatar.png' }}" alt="Avatar" class="avatar">
                <div class="card-content">
                    <div class="card-header">
                        <span class="username">{{ message.sender.username }}</span>
                        <span class="message-date">{{ message.created_at|timesince }} ago</span>
                    </div>
                    <div class="message-preview">{{ message.content|truncatechars:50 }}</div>
                </div>
            </div>
            {% empty %}
            <div class="empty-state">
                <p>No messages yet. Start a conversation!</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Message thread (right side) -->
    <div class="message-thread">
        <div class="thread-header">
            <img src="{% static 'img/default-avatar.png' %}" alt="Avatar" class="avatar">
            <h3 class="thread-header-name">Select a conversation</h3>
        </div>
        <div class="messages-list" id="messagesList"></div>
        <div class="message-input">
            <div class="message-actions">
                <button class="action-btn" title="Add image">
                    <i class="fas fa-image"></i>
                </button>
                <button class="action-btn" title="Add GIF">
                    <i class="fas fa-gift"></i>
                </button>
                <button class="action-btn" title="Add emoji">
                    <i class="fas fa-smile"></i>
                </button>
            </div>
            <textarea id="messageInput" placeholder="Type a message..." rows="1"></textarea>
            <button id="sendMessageBtn" class="send-btn">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- New Message Modal -->
    <div id="newMessageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>New message</h3>
                <button class="close-modal" onclick="closeNewMessageModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="search-container">
                    <input type="text" id="userSearch" placeholder="Search users..." onkeyup="searchUsers(this.value)">
                    <div id="searchResults" class="search-results"></div>
                </div>
                <div id="selectedUsers" class="selected-users"></div>
            </div>
            <div class="modal-footer">
                <button class="cancel-btn" onclick="closeNewMessageModal()">Cancel</button>
                <button class="next-btn" onclick="startNewConversation()">Next</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal (hidden by default) -->
    <div id="settingsModal" class="modal" style="display:none;">
        <div class="modal-content">
            {% include 'core/message_settings.html' %}
        </div>
    </div>
{% endblock %}

{% block sidebar %}
    <!-- Empty to prevent default sidebar content from rendering -->
{% endblock %}

{% block extra_js %}
<script type="module">
    import { init } from "{% static 'js/pages/messages.js' %}";
    document.addEventListener('DOMContentLoaded', function() {
        init();
    });
</script>
<script>
    function openSettingsModal() {
        document.getElementById('settingsModal').style.display = 'block';
    }
    function closeSettingsModal() {
        document.getElementById('settingsModal').style.display = 'none';
    }
    // Close modal when clicking outside modal-content
    window.addEventListener('click', function(event) {
        const modal = document.getElementById('settingsModal');
        if (event.target === modal) {
            closeSettingsModal();
        }
    });
    // Also close on X button in modal
    document.addEventListener('DOMContentLoaded', function() {
        const closeBtn = document.getElementById('closeSettingsBtn');
        if (closeBtn) {
            closeBtn.onclick = closeSettingsModal;
        }
    });
</script>
{% endblock %}